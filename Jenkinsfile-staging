#!/usr/bin/env groovy

node ('evalg') {
    def workspace = pwd()
    def project = 'it-usit-int-drift'
    def image_version

    stage ('Checkout') {
        checkout scm
        image_version = sh(
            returnStdout: true,
            script: 'git describe --dirty=+ --tags'
        ).trim() - /^v/
    }
    stage ('Build evalg image') {
        sh "docker build \
            -t '${project}/valg-backend' \
            -f Dockerfile-staging ."
        sh "docker tag '${project}/valg-backend' '${project}/valg-backend:${image_version}'"
    }
    stage ('Push images') {
        sh "docker push '${project}/valg-backend'"
    }
}
