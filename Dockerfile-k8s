FROM harbor.uio.no/library/docker.io-python:3.8-slim

MAINTAINER USITINT <bnt-int@usit.uio.no>
LABEL no.uio.contact=bnt-int@usit.uio.no

# Proxy for updates during build
ENV http_proxy="http://software-proxy.uio.no:3128"
ENV https_proxy="https://software-proxy.uio.no:3128"

RUN apt-get update && apt-get install -y \
    git \
    && rm -rf /var/lib/apt/lists/*

ENV http_proxy=""
ENV https_proxy=""

COPY . /tmp/evalg

RUN pip config set global.index-url https://repo.usit.uio.no/nexus/repository/pypi-usit/simple \
 && pip config set global.index https://repo.usit.uio.no/nexus/repository/pypi-usit/pypi \
 && pip install -r /tmp/evalg/requirements.txt

RUN pip install /tmp/evalg


RUN useradd --create-home evalg
WORKDIR /home/evalg
USER evalg

COPY evalg/migrations /usr/src/evalg/evalg/migrations
COPY evalg/migrations /home/evalg/evalg/migrations

# Set instance path
ENV EVALG_CONFIG="/usr/local/var/evalg-instance/evalg_config.py"
ENV FLASK_APP="evalg.wsgi"

EXPOSE 8000

CMD ["gunicorn", "--workers=1", "--bind=0.0.0.0:8000", "evalg.wsgi:app"]
