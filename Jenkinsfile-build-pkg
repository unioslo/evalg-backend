#!/usr/bin/env groovy

pipeline {
    agent { label 'docker'}
    stages {
        stage('Build, test and deploy python package') {
            agent { 
                docker { image 'harbor.uio.no/it-usit-int-drift/jenkins-python-3:latest' }
            }
            environment {
                PIP_INDEX_URL='https://repo.usit.uio.no/nexus/repository/pypi-usit/simple'
                PIP_EXTRA_INDEX_URL='https://repo.usit.uio.no/nexus/repository/pypi-usit/pypi'
            }
            stages {
                stage('Run unit tests') {
                    steps {
                        sh 'tox --recreate'
                    }
                }
                stage('Build source distribution') {
                    steps {
                        sh 'python setup.py sdist'
                        archiveArtifacts artifacts: 'dist/evalg-*.tar.gz'
                    }
                }
                stage('Deploy pkg to Nexus') {
                    when { branch 'master' }
                    steps {
                        build(
                            job: 'python-publish',
                            parameters: [
                                string(name: 'project', value: "${JOB_NAME}"),
                                string(name: 'build', value: "${BUILD_ID}"),
                            ]
                        )
                    }
                }
            }
            post {
                always {
                    junit '**/junit*.xml'
                    publishCoverage adapters: [coberturaAdapter(path: '**/coverage*.xml')]
                }
                cleanup {
                    sh('rm -vf junit-*.xml')
                    sh('rm -vf coverage-*.xml')
                    sh('rm -vrf build dist')
                }
            }
        }
    }
}
